<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrabStitch v0.3.0</title>
    <style>
      :root {
        --primary: #2ecc71;
        --bg: #f8f9fa;
        --surface: #ffffff; /* New: For cards/modals */
        --text: #333;
        --border: #ddd;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --primary: #2ecc71;
          --bg: #0f0f0f;      /* Deepest background */
          --surface: #1a1a1a; /* Slightly lighter for cards */
          --text: #ececec;
          --border: #333;
        }
      }
      * { box-sizing: content-box; }
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0; padding: 0;
        background: var(--bg); color: var(--text);
        height: 100vh; display: flex; flex-direction: column; overflow: hidden;
      }

      /* TABS */
      .tabs {
        flex: 0 0 auto; display: flex;
        background: var(--surface); /* Changed to Surface */
        padding: 10px 20px 0; border-bottom: 1px solid var(--border);
      }
      .tab {
        padding: 10px 20px; cursor: pointer;
        border-bottom: 2px solid transparent; font-weight: 600;
        color: #888; transition: 0.2s;
      }
      .tab:hover { color: var(--primary); }
      .tab.active { border-bottom-color: var(--primary); color: var(--primary); }

      /* CONTENT */
      .scroll-container { flex: 1 1 auto; overflow-y: auto; padding: 20px; }
      /* --- CUSTOM SCROLLBAR --- */
      
      /* Width of the scrollbar */
      .scroll-container::-webkit-scrollbar {
        width: 10px;
      }

      /* The track (background) */
      .scroll-container::-webkit-scrollbar-track {
        background: transparent; /* Blends with the background */
      }

      /* The draggable handle */
      .scroll-container::-webkit-scrollbar-thumb {
        background-color: var(--border); /* Uses your theme's border color (dark grey) */
        border-radius: 20px;       /* Roundness */
        border: 3px solid var(--bg); /* Creates a padding effect around the thumb */
      }

      /* Handle on hover */
      .scroll-container::-webkit-scrollbar-thumb:hover {
        background-color: #555; /* Slightly lighter when you grab it */
      }
      .content { display: none; animation: fadeIn 0.2s; }
      .content.active { display: block; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

      /* GROUPS */
      .group {
        background: var(--surface); /* Changed to Surface */
        border: 1px solid var(--border);
        border-radius: 8px; padding: 20px; margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
      }
      .group h3 {
        margin-top: 0; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;
        color: #888; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;
      }

      /* INPUTS & LAYOUT */
      label { display: block; font-size: 13px; margin-bottom: 6px; font-weight: 600; color: var(--text); }
      .row { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
      .col { flex: 1; }

      input[type="text"], input[type="number"], select {
        width: 100%; padding: 10px;
        border: 1px solid var(--border);
        background: var(--bg); /* Input stays dark */
        color: var(--text);
        border-radius: 6px; box-sizing: border-box; font-size: 14px;
        height: 40px;
      }
      input:focus, select:focus { border-color: var(--primary); outline: none; }

      button {
        height: 40px; background: var(--primary); color: white;
        border: none; padding: 0 20px; border-radius: 6px;
        cursor: pointer; font-weight: 600; white-space: nowrap;
        display: inline-flex; align-items: center; justify-content: center;
      }
      button:hover:not(:disabled) { opacity: 0.9; }
      button:disabled { opacity: 0.7; cursor: not-allowed; }
      button.danger { background: #e74c3c; }
      button.secondary { background: #3498db; }
      button.outline { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
      button.outline:hover { background: var(--bg); border-color: var(--text); }

      /* CHECKBOX */
      .checkbox-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
      input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--primary); }

      /* FOOTER */
      .status-area {
        flex: 0 0 auto; background: var(--surface);
        padding: 15px 20px; border-top: 1px solid var(--border); z-index: 10;
      }
      .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      progress {
        width: 100%; height: 6px; border-radius: 3px; accent-color: var(--primary); appearance: none;
      }
      progress::-webkit-progress-bar { background-color: var(--border); border-radius: 3px; }
      progress::-webkit-progress-value { background-color: var(--primary); border-radius: 3px; }
      .hint { font-size: 12px; color: #888; margin-top: -10px; margin-bottom: 15px; font-style: italic; }

      /* CUSTOM MODAL */
      .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
        display: none; justify-content: center; align-items: center; z-index: 1000;
        opacity: 0; transition: opacity 0.2s;
      }
      .modal-overlay.open { display: flex; opacity: 1; }

      .modal-box {
        background: var(--surface); /* Corrected for Dark Mode */
        color: var(--text);
        padding: 25px; border-radius: 8px; border: 1px solid var(--border);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); width: 350px;
        transform: scale(0.9); transition: transform 0.2s;
      }
      .modal-overlay.open .modal-box { transform: scale(1); }

      .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
      .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
  </head>
  <body>
    <div class="tabs">
      <div class="tab active" id="tab-basic">Basic</div>
      <div class="tab" id="tab-advanced">Advanced</div>
      <div class="tab" id="tab-post">Post Process</div>
    </div>

    <div class="scroll-container">
      <!-- BASIC -->
      <div id="basic" class="content active">
        <div class="group">
          <h3>Input & Output</h3>
          <label>Input Folder Path</label>
          <div class="row">
            <input type="text" id="inputPath" placeholder="Select folder containing images" />
            <button id="browseIn">Browse</button>
          </div>
          <div class="checkbox-row">
            <input type="checkbox" id="batchMode" />
            <label for="batchMode" style="margin: 0; cursor: pointer">Batch Mode (Sub-folders)</label>
          </div>
          <label>Output Folder Path (Optional)</label>
          <div class="row">
            <input type="text" id="outputPath" placeholder="Default: [Stitched] folder created automatically" />
            <button id="browseOut">Browse</button>
          </div>
        </div>

        <div class="group">
          <h3>Image Settings</h3>
          <div class="row">
            <div class="col">
              <label>Output Format</label>
              <select id="outputType">
                <option value=".png">PNG (Lossless)</option>
                <option value=".jpg">JPG (Smaller)</option>
                <option value=".webp">WebP (Efficient)</option>
                <option value=".avif">AVIF (Next Gen)</option>
                <option value=".bmp">BMP (Raw)</option>
              </select>
            </div>
            <div class="col">
              <label>Split Height (px)</label>
              <input type="number" id="splitHeight" value="5000" />
            </div>
          </div>
          <label>Width Enforcement</label>
          <select id="widthMode" style="margin-bottom: 15px">
            <option value="1">Automatic Uniform (Match First Image)</option>
            <option value="4">Match Maximum Width (Padding)</option>
            <option value="2">Match Minimum Width (Crop/Resize)</option>
            <option value="3">Custom Width</option>
            <option value="0">No Enforcement (Split on width change)</option>
          </select>
          <div id="customWidthBox" style="display: none">
            <label>Custom Width (px)</label>
            <div class="row"><input type="number" id="customWidth" value="720" /></div>
          </div>
          <div id="paddingColorBox" style="display: none">
            <label>Background Fill Color</label>
            <div class="row">
              <select id="fillColor">
                <option value="0">Black</option>
                <option value="1">White</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- ADVANCED -->
      <div id="advanced" class="content">
        <div class="group">
          <h3>Configuration Profile</h3>
          <label>Current Profile</label>
          <div class="row">
            <select id="profileSelect" style="flex-grow: 1"></select>
            <button class="outline" id="btnSave">Save</button>
            <button class="secondary" id="btnAdd">Add New</button>
            <button class="danger" id="btnDelete">Delete</button>
          </div>
          <div class="hint">Select a profile to load settings.</div>
        </div>
        <div class="group">
          <h3>Detection Algorithm</h3>
          <label>Detector Type</label>
          <select id="detectorType" style="margin-bottom: 15px">
            <option value="0">Smart Pixel Comparison (Detects Panels)</option>
            <option value="1">Direct Split (Fixed Height Cut)</option>
          </select>
          <div id="smartSettings">
            <div class="row">
              <div class="col"><label>Sensitivity</label><input type="number" id="sensitivity" value="90" min="1" max="100" /></div>
              <div class="col"><label>Scan Step</label><input type="number" id="scanStep" value="5" /></div>
            </div>
            <label>Ignorable Margin</label>
            <div class="row"><input type="number" id="margin" value="5" /></div>
          </div>
        </div>
      </div>

      <!-- POST PROCESS -->
      <div id="post" class="content">
        <div class="group">
          <h3>External Command</h3>
          <div class="checkbox-row">
            <input type="checkbox" id="enablePost" />
            <label for="enablePost" style="margin: 0; cursor: pointer">Run post process after stitching</label>
          </div>
          <label>Script Path</label>
          <div class="row"><input type="text" id="postPath" /><button id="browsePost">Browse</button></div>
          <label>Arguments</label>
          <div class="row"><input type="text" id="postArgs" placeholder="-opt {output}" /></div>
          <div class="hint">Use <b>{output}</b> as placeholder for stitched folder path.</div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="status-area">
      <div class="status-bar">
        <input type="text" id="statusText" value="Ready" readonly style="background: transparent; border: none; font-weight: 600; width: 70%;" />
        <button id="startBtn">Start Process</button>
      </div>
      <progress id="progressBar" value="0" max="100"></progress>
    </div>

    <!-- MODAL -->
    <div id="modalOverlay" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-title">Create New Profile</div>
        <label>Profile Name</label>
        <input type="text" id="newProfileName" />
        <div class="modal-actions">
          <button class="outline" id="modalCancel">Cancel</button>
          <button class="secondary" id="modalConfirm">Create</button>
        </div>
      </div>
    </div>

    <script type="module">
      try {
        const core = await import("@tauri-apps/api/core");
        const event = await import("@tauri-apps/api/event");
        const dialog = await import("@tauri-apps/plugin-dialog");
        const { invoke } = core; const { listen } = event; const { open } = dialog;

        function switchTab(tabName) {
          document.querySelectorAll(".content").forEach((d) => d.classList.remove("active"));
          document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
          document.getElementById(tabName).classList.add("active");
          document.getElementById("tab-" + tabName).classList.add("active");
        }
        ["basic", "advanced", "post"].forEach((t) => document.getElementById("tab-" + t).addEventListener("click", () => switchTab(t)));

        document.getElementById("widthMode").addEventListener("change", (e) => {
          const val = e.target.value;
          document.getElementById("customWidthBox").style.display = val == "3" ? "block" : "none";
          document.getElementById("paddingColorBox").style.display = val == "4" || val == "3" ? "block" : "none";
        });
        document.getElementById("detectorType").addEventListener("change", (e) => {
            document.getElementById("smartSettings").style.display = e.target.value == "1" ? "none" : "block";
        });

        async function handleBrowse(targetId, isFile = false) {
          try {
            const opts = isFile ? { filters: [{ name: "All Files", extensions: ["*"] }] } : { directory: true };
            const selected = await open(opts);
            if (selected) document.getElementById(targetId).value = selected;
          } catch (err) { alert("Error: " + err); }
        }
        document.getElementById("browseIn").addEventListener("click", () => handleBrowse("inputPath"));
        document.getElementById("browseOut").addEventListener("click", () => handleBrowse("outputPath"));
        document.getElementById("browsePost").addEventListener("click", () => handleBrowse("postPath", true));

        let currentProfiles = {};
        function applySettings(s) {
          document.getElementById("inputPath").value = s.input_path;
          document.getElementById("outputPath").value = s.output_path;
          document.getElementById("outputType").value = s.output_type;
          document.getElementById("splitHeight").value = s.split_height;
          document.getElementById("widthMode").value = s.width_enforce_type;
          document.getElementById("customWidth").value = s.custom_width;
          document.getElementById("sensitivity").value = s.sensitivity;
          document.getElementById("scanStep").value = s.scan_step;
          document.getElementById("margin").value = s.ignorable_margin;
          document.getElementById("batchMode").checked = s.batch_mode;
          document.getElementById("detectorType").value = s.detector_type;
          document.getElementById("fillColor").value = s.fill_color;
          document.getElementById("enablePost").checked = s.enable_post_process;
          document.getElementById("postPath").value = s.post_process_path;
          document.getElementById("postArgs").value = s.post_process_args;
          document.getElementById("widthMode").dispatchEvent(new Event("change"));
          document.getElementById("detectorType").dispatchEvent(new Event("change"));
        }
        function getSettingsFromUI() {
          return {
            input_path: document.getElementById("inputPath").value,
            output_path: document.getElementById("outputPath").value,
            output_type: document.getElementById("outputType").value,
            split_height: parseInt(document.getElementById("splitHeight").value) || 5000,
            width_enforce_type: parseInt(document.getElementById("widthMode").value),
            custom_width: parseInt(document.getElementById("customWidth").value) || 720,
            sensitivity: parseInt(document.getElementById("sensitivity").value) || 90,
            scan_step: parseInt(document.getElementById("scanStep").value) || 5,
            ignorable_margin: parseInt(document.getElementById("margin").value) || 5,
            batch_mode: document.getElementById("batchMode").checked,
            detector_type: parseInt(document.getElementById("detectorType").value),
            fill_color: parseInt(document.getElementById("fillColor").value),
            enable_post_process: document.getElementById("enablePost").checked,
            post_process_path: document.getElementById("postPath").value,
            post_process_args: document.getElementById("postArgs").value,
          };
        }
        async function refreshProfiles(data) {
          if (!data) data = await invoke("get_all_profiles");
          currentProfiles = data.profiles;
          const sel = document.getElementById("profileSelect");
          sel.innerHTML = "";
          Object.keys(data.profiles).sort().forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name; opt.innerText = name;
            if (name === data.current_profile) opt.selected = true;
            sel.appendChild(opt);
          });
          if (currentProfiles[data.current_profile]) applySettings(currentProfiles[data.current_profile]);
        }

        document.getElementById("profileSelect").addEventListener("change", async (e) => {
            const name = e.target.value; await invoke("set_current_profile", { name }); applySettings(currentProfiles[name]);
        });
        document.getElementById("btnSave").addEventListener("click", async () => {
            const name = document.getElementById("profileSelect").value;
            await invoke("save_profile", { name, settings: getSettingsFromUI() });
            const btn = document.getElementById("btnSave"); const original = btn.innerText; btn.innerText = "Saved!"; setTimeout(()=>btn.innerText=original,1000);
        });
        document.getElementById("btnDelete").addEventListener("click", async () => {
            const name = document.getElementById("profileSelect").value;
            if (name === "Default") return alert("Cannot delete Default");
            if (confirm("Delete '" + name + "'?")) {
              const newData = await invoke("delete_profile", { name }); await refreshProfiles(newData);
            }
        });

        const modal = document.getElementById("modalOverlay");
        const nameInput = document.getElementById("newProfileName");
        document.getElementById("btnAdd").addEventListener("click", () => { modal.classList.add("open"); nameInput.value=""; nameInput.focus(); });
        document.getElementById("modalCancel").addEventListener("click", () => modal.classList.remove("open"));
        async function createProfile() {
            const name = nameInput.value.trim();
            if (!name || currentProfiles[name]) return;
            await invoke("save_profile", { name, settings: getSettingsFromUI() });
            await invoke("set_current_profile", { name }); await refreshProfiles();
            modal.classList.remove("open");
        }
        document.getElementById("modalConfirm").addEventListener("click", createProfile);
        nameInput.addEventListener("keypress", (e) => { if(e.key==="Enter") createProfile(); });

        await refreshProfiles();
        listen("status", (e) => document.getElementById("statusText").value = e.payload);
        listen("progress", (e) => document.getElementById("progressBar").value = e.payload);

        document.getElementById("startBtn").addEventListener("click", async () => {
            const s = getSettingsFromUI();
            if (!s.input_path) return alert("Select input folder");
            const btn = document.getElementById("startBtn");
            btn.disabled = true; btn.innerText = "Running...";
            try { await invoke("run_smart_stitch", { settings: s }); }
            catch (e) { alert("Error: " + e); document.getElementById("statusText").value = "Error"; }
            finally { btn.disabled = false; btn.innerText = "Start Process"; }
        });
      } catch (e) { alert("Init Error: " + e); }
    </script>
  </body>
</html>